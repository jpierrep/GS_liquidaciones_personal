<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" 
    crossorigin="anonymous">

  <title>Procesos</title>


  <style>
    .progress-bar-vertical {
      width: 20px;
      min-height: 100px;
      display: flex;
      align-items: flex-end;
      margin-right: 20px;
      float: left;
    }
        </style>
</head>

<body>

  <div class="alert alert-danger" id="global-alert" role="alert"   style="display:none;">
    <strong>Error!</strong> Archivo sin formato o sin ruts.
  </div>

  <div class="container">
    <div class="row">

      <div class="col-6"> Empresa:
        <select id="empresa-select" class="custom-select custom-select-lg mb-3">

          <option selected value="0">Guard Service Seguridad S.A.</option>
          <option value="2">GS Outsourcing S.A.</option>

        </select>
      </div>
      <div class="col-6"> Mes:
        <select id="mes-select" class="custom-select custom-select-lg mb-3">

          <option selected value="2020-10-01">2020-10</option>


        </select>
      </div>
    </div>
  </div>


  <div class="container">
    <div class="row">

      <div class="col-sm-12">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Liquidaciones
              <a class='ui-all' style=" font-weight: normal;font-size: 1rem;" tabindex='-1' id="liquidacion-log-modal-button"
                data-toggle="modal" data-target="#exampleModalCenter">
                [logs]
              </a>
            </h5>

            <p class="card-text">Genera archivos de liquidaciones del mes anterior.</p>
            <div class="row">
              <div class="col-1">
                <button type="button" id="liquidacion-empieza" class="btn btn-primary" disabled>Ejecutar</button>
              </div>
              <div class="col-8 " style="padding:10px;margin: auto">

                <div name="liquidacion-loader" class=" progress">
                  <div id='liquidacion-progress' class="progress-bar progress-bar-striped progress-bar-animated " role="progressbar"
                    aria-valuenow="5" aria-valuemin="0" aria-valuemax="100" style="width: 5%">5%</div>

                </div>

              </div>
              <div class="col-1">
                <span name=" liquidacion-loader " id="liquidacion-cc-status"> </span>
              </div>
            </div>



          </div>

        </div>
      </div>





    </div>

  </div>

  <!-- Modal -->
  <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLongTitle">Registros Procesos</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">

          <ul class="list-group">

          </ul>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>

        </div>
      </div>
    </div>
  </div>





<!-- Modal alert sobreescribe proceso-->

 <!-- Modal -->
<div class="modal fade" id="process-modal-backup"  data-process-modal-backup="aa" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Proceso para el mes seleccionado ya existe</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Se encontró que ya existe un proceso en el mes y empresa seleccionados ¿Desea sobreescribirlo?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Salir</button>
        <button type="button" onclick="executeProcess()"  data-dismiss="modal"  class="btn btn-primary">Si</button>
      </div>
    </div>
  </div>
</div>





  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  
  <script src="/js/jquery.min.js"></script> 
  <!--<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>-->
  <script src="/js/popper.min.js" 
    crossorigin="anonymous"></script>
  <script src="/js/bootstrap.min.js" 
    crossorigin="anonymous"></script>

  <script src="/js/socket.io.js" 
    crossorigin="anonymous"></script>

  <script>
    var socket = io();
    var procesoSelected=""
    
    


    $(document).ready(function () {


let m=new Date()
    // let mesActual=m.getFullYear()+"-"((m.getMonth() + 1) > 9 ? (m.getMonth() + 1) : '0' + (m.getMonth() + 1))+"-01"
     let mesAnterior=""
     //si el mes actual es enero, se debe setear diciembre del mes anterior
     if(m.getMonth()==0){
      mesAnterior=m.getFullYear()-1+"-12-01"
     }else{
      mesAnterior=m.getFullYear()+"-"+((m.getMonth() ) > 9 ? (m.getMonth()) : '0' + (m.getMonth()))+"-01"
     }
  

      //valores del select
      $('#mes-select').empty()
    
      $('#mes-select').append(`<option selected value="`+mesAnterior+`"> `+mesAnterior.substr(0,7)+`</option>`); 

      //saveFile("Example.txt", "data:attachment/text", "Hello, world.");
      //socket.emit("getFile","holaaaa");
      //esto hace que se dupliquen los archivos pues se llama al getFilename que carga lista de archivos
      //  socket.emit("getFileName", "holaaaa");
      
      //el proceso seleccionado queda cargado en el modal
      //https://blog.nubecolectiva.com/que-son-los-atributos-data-toggle-data-set-etc-en-html5/
      var ca = document.querySelector('#process-modal-backup');
      console.log("procesoactivo",ca.dataset)
    
      var countries = ['United States', 'Canada', 'Argentina', 'Armenia'];
     // $("#empresa-select").val(2);
      console.log(countries)
    });

 

    $('#liquidacion-log-modal-button').click(function () {
      var empresa = $("#empresa-select").val();
      socket.emit("getFileName", "liquidacionCobranzas", empresa);
      $('ul.list-group').empty()


    });


        $('#liquidacion-empieza').on("click", function () {
     
      procesoSelected="liquidacionCobranzas"
      let empresa = $("#empresa-select").val();
      let mes = $("#mes-select").val();      
      //se consulta si ya existe el proceso via socket, la respuesta llega en on resExistsDirDestino , si no existe se ejecuta el proceso executeProcess, si existe se levantarà popup
      socket.emit("getExistsDirDestino", { empresa: empresa, mes: mes,proceso:procesoSelected });

     


    });
    


    //ojo que para reconocer los elementos dinamicos se debe usar el on click y no click como funcion

    $(".list-group").on("click", "li", function () {
      console.log($(this).text());

      //getFile y el nombre del archivo

      socket.emit("getFile", $(this).text());
    });

    socket.on('sendfile', function (data, fileName) {
      saveFile(fileName, "data:attachment/text", data);
    })

    socket.on('sendFileNames', function (data) {

      console.log(data) //listado de archivos array
      //crear listado selector jquery con los archivos
      //https://stackoverflow.com/questions/5881033/how-to-generate-ul-li-list-from-string-array-using-jquery

      countries = data
      var cList = $('ul.list-group').append(
        countries.map(country =>
          $("<li class='list-group-item'>").append($("<a class='ui-all' tabindex='-1'> ").text(country))
        )
      );

    })


  socket.on('resExistsDirDestino', function (existsDirDestino) {
// si existe ya la el proceso (carpeta y empresa) se backapea, si no, se ejecuta
     
    if(existsDirDestino)  $('#process-modal-backup').modal('show'); 
    else  executeProcess()
   
   })



    //cuando el back envía eventos de actualización de procesos

    socket.on('getStatusLiquidacionCobranzas', function (data) {
      //    $("#messages").append('<li class="list-group-item">'+msg+'</li>');
      //console.log("Termina "+msg)
     console.log(data)
      if (!data.isExecuting) {
        $("#mes-select").attr("disabled", false);
        $("#empresa-select").attr("disabled", false);
        //valor por defecto del select de empresa es Guard
        $("#empresa-select").val(0);
        $('#liquidacion-empieza').attr("disabled", false); 
        $("[name='liquidacion-loader']").hide()
        $('#liquidacion-cc-status').text("")
      }

      else {
       
        $("#mes-select").attr("disabled", true);
        $("#empresa-select").attr("disabled", true);
        //muestra en el select la empresa que se está ejecutando
        $("#empresa-select").val(data.userParams.empresa);
        $("#mes-select").val(data.userParams.mes);
        $("[name='liquidacion-loader']").show()
        $('#liquidacion-empieza').attr("disabled", true);
        $('#liquidacion-cc-status').text(data.msgs[0])
        $('#liquidacion-progress').attr('style', "width:" + data.percent + "%")
        $('#liquidacion-progress').attr('aria-valuenow', data.percent)
        $('#liquidacion-progress').text(data.percent + "%")
      }
    });

        socket.on('getGlobalAlert', function (data) {
        //data.type: error (rojo), success (verde), warning (amarillo)
        var alertClass
        if(data.type=="error")
        alertClass='alert alert-danger'
        if(data.type=="success")
        alertClass='alert alert-success'
        

         
          $('#global-alert').removeClass($('#global-alert').attr('class'))
          
          $('#global-alert').text(data.messaje); 
         
          $('#global-alert').addClass(alertClass)
    $('#global-alert').fadeTo(2000, 500).slideUp(500, function(){
    $('#global-alert').hide(); });  //si le seteo alert.close se elimina del dom, por lo que no vuelve a aparecer
       

});

function executeProcess(){
//  $('#process-modal-backup').modal('hide'); 
console.log("ejecutando proceso",procesoSelected)

if(procesoSelected=="liquidacionCobranzas"){

  var empresa = $("#empresa-select").val();
  var mes = $("#mes-select").val();
  $("[name='liquidacion-loader']").show()
  socket.emit("getLiquidacionesCobranzas", { empresa: empresa, mes: mes });

}


}

   //descarga archivo al cliente

    function saveFile(name, type, data) {
      if (data !== null && navigator.msSaveBlob)
        return navigator.msSaveBlob(new Blob([data], { type: type }), name);
      var a = $("<a style='display: none;'/>");
      var url = window.URL.createObjectURL(new Blob([data], { type: type }));
      a.attr("href", url);
      a.attr("download", name);
      $("body").append(a);
      a[0].click();
      window.URL.revokeObjectURL(url);
      a.remove();
    }



  </script>

</body>

</html>